body:
  $let:
    contactMobile: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='contact-mobile').answer.valueString").0
    address: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='address').answer.valueString").0
    contactFirstName: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='contact-first-name').answer.valueString").0
    email: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='email').answer.valueString").0
    addContact: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='add-contact').answer.valueBoolean").0
    contactLastName: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='contact-last-name').answer.valueString").0
    birthDate: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='birth-date').answer.valueDate").0
    ssn: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='ssn').answer.valueString").0
    firstName: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='first-name').answer.valueString").0
    contactEmail: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='contact-email').answer.valueString").0
    hmo: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='hmo').answer.valueReference").0
    phm: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='phm').answer.valueReference").0
    lastName: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='last-name').answer.valueString").0
    navigator: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='navigator').answer.valueReference").0
    contactRelationship: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='contact-relationship').answer.valueCoding").0
    gender: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='gender').answer.valueCoding.code").0
    mobile: >-
      $
      fhirpath("QuestionnaireResponse.repeat(item).where(linkId='mobile').answer.valueString").0
  $body:
    $let:
      hmoReferenceSplit:
        $args:
          - $ hmo.reference
          - /
        $call: splitStr
      phmReferenceSplit:
        $args:
          - $ phm.reference
          - /
        $call: splitStr
      navigatorReferenceSplit:
        $args:
          - $ navigator.reference
          - /
        $call: splitStr
    $body:
      type: transaction
      entry:
        - request:
            url: /Patient
            method: POST
          resource:
            address:
              - text: $ address
            managingOrganization:
              id: $ hmoReferenceSplit.1
              display: $ hmo.display
              resourceType: $ hmoReferenceSplit.0
            name:
              - given:
                  - $ firstName
                family: $ lastName
            birthDate: $ birthDate
            resourceType: Patient
            active: true
            identifier:
              - value: $ ssn
                system: http://fhir.health.gov.il/identifier/il-national-id
            telecom:
              - value: $ mobile
                system: phone
              - value: $ email
                system: email
            gender: $ gender
            contact:
              - $if: $ addContact
                $then:
                  name:
                    given:
                      - $ contactFirstName
                    family: $ contactLastName
                  telecom:
                    - use: work
                      value: $ contactMobile
                      system: phone
                    - use: work
                      value: $ contactEmail
                      system: email
                  relationship:
                    - coding:
                        - code: $ contactRelationship.code
                          system: $ contactRelationship.system
                          display: $ contactRelationship.display
        - request:
            url: /CareTeam
            method: POST
          resource:
            status: active
            participant:
              - member:
                  id: $ phmReferenceSplit.1
                  display: $ phm.display
                  identifier:
                    value: phm
                  resourceType: $ phmReferenceSplit.0
              - member:
                  id: $ navigatorReferenceSplit.1
                  display: $ navigator.display
                  identifier:
                    value: navigator
                  resourceType: $ navigatorReferenceSplit.0
            resourceType: CareTeam
      resourceType: Bundle
id: patient-create
resourceType: Mapping
